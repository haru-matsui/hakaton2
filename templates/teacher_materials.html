{% extends "base.html" %} {% block title %}Управление материалами{% endblock %} {% block extra_css %}
<style>
    .upload-section {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .upload-section h3 {
        color: var(--primary-color);
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        font-weight: 600;
        color: #2a1468;
        margin-bottom: 8px;
        display: block;
    }

    .file-upload-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: auto;
    }

    .file-upload-input {
        font-size: 100px;
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
        width: 100%;
        height: 100%;
    }

    .file-upload-button {
        display: inline-block;
        padding: 12px 24px;
        background: var(--primary-color);
        color: white;
        border-radius: 10px;
        cursor: default;
        font-weight: 600;
    }

    .file-name {
        margin-left: 15px;
        color: #2a1468;
        font-style: italic;
    }

    .btn-upload {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .btn-upload:hover {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .materials-list {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .material-item {
        padding: 15px;
        border-bottom: 1px solid #e8e8e8;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .material-item:last-child {
        border-bottom: none;
    }

    .material-info h5 {
        margin: 0 0 5px 0;
        color: #2a1468;
    }

    .material-meta {
        font-size: 0.9rem;
        color: #2a1468;
    }

    .btn-delete {
        background: var(--danger-color);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
    }

    .btn-delete:hover {
        background: var(--danger-color);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
    }

    .alert {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .alert-success {
        background: #c1f26b;
        color: #2a1468;
        border: 1px solid var(--success-color);
    }

    .alert-danger {
        background: #ffa039;
        color: #2a1468;
        border: 1px solid var(--danger-color);
    }

    .groups-dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        margin-top: 2px;
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .groups-dropdown-list.show {
        display: block;
    }

    .group-option-item {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
    }

    .group-option-item:hover {
        background-color: #f8f9fa;
    }

    .selected-group-badge {
        background: var(--primary-color);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.875rem;
    }

    .selected-group-badge .remove-badge {
        cursor: pointer;
        font-weight: bold;
        font-size: 1rem;
        margin-left: 2px;
    }

    .selected-group-badge .remove-badge:hover {
        color: #ffd700;
    }
</style>
{% endblock %} {% block content %}
<div class="page-header">
    <h1><i class="bi bi-upload"></i> Управление материалами</h1>
    <p class="text-muted">Загрузка учебных материалов для студентов</p>
</div>

<!-- Форма загрузки -->
<div class="upload-section">
    <h3><i class="bi bi-cloud-upload"></i> Загрузить новый материал</h3>

    {% if success %}
    <div class="alert alert-success">
        <i class="bi bi-check-circle"></i> {{ success }}
    </div>
    {% endif %} {% if error %}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> {{ error }}
    </div>
    {% endif %}

    <form method="POST" action="/teacher/upload_material" enctype="multipart/form-data">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label>Название материала *</label>
                    <input type="text" class="form-control" name="title" required placeholder="Например: Лекция 1. Введение">
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-group">
                    <label>Группы *</label>
                    <div style="position: relative;">
                        <div class="form-select" id="groupsSelector" style="cursor: pointer; display: flex; flex-wrap: wrap; gap: 5px; min-height: 38px; align-items: center; padding: 8px;">
                            <span id="groupsPlaceholder" style="color: #6c757d;">Выберите группы</span>
                        </div>
                        <div class="groups-dropdown-list" id="groupsDropdownList">
                            {% for group in groups %}
                            <div class="group-option-item" data-group="{{ group }}">
                                <input type="checkbox" id="group_{{ loop.index }}" value="{{ group }}" style="margin-right: 8px;">
                                <label for="group_{{ loop.index }}" style="margin: 0; cursor: pointer;">{{ group }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <input type="hidden" name="group_names" id="groupNamesInput" required>
                    <small class="text-muted">Выберите одну или несколько групп</small>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label>Предмет *</label>
                    <input type="text" class="form-control" name="subject" required placeholder="Например: Математический анализ">
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-group">
                    <label>Тип материала *</label>
                    <select class="form-select" name="file_type" required>
                    <option value="">Выберите тип</option>
                    <option value="Лекция">Лекция</option>
                    <option value="Презентация">Презентация</option>
                    <option value="Практика">Практическая работа</option>
                    <option value="Другое">Другое</option>
                </select>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Описание</label>
            <textarea class="form-control" name="description" rows="3" placeholder="Краткое описание материала (необязательно)"></textarea>
        </div>

        <div class="form-group">
            <label>Файл (PDF, DOCX, PPTX) *</label>
            <div class="file-upload-wrapper">
                <div class="file-upload-button">
                    <i class="bi bi-paperclip"></i> Выбрать файл
                </div>
                <span class="file-name" id="fileName">Файл не выбран</span>
                <input type="file" name="file" class="file-upload-input" accept=".pdf,.docx,.pptx,.doc,.ppt" required onchange="updateFileName(this)">
            </div>
        </div>

        <button type="submit" class="btn btn-upload">
        <i class="bi bi-cloud-upload"></i> Загрузить материал
    </button>
    </form>
</div>

<!-- Список загруженных материалов -->
<div class="materials-list">
    <h3><i class="bi bi-files"></i> Загруженные материалы</h3>

    {% if materials %} {% for material in materials %}
    <div class="material-item">
        <div class="material-info">
            <h5>{{ material.title }}</h5>
            <div class="material-meta">
                <span><i class="bi bi-book"></i> {{ material.subject }}</span> |
                <span><i class="bi bi-people"></i> {{ material.group_name }}</span> |
                <span><i class="bi bi-calendar"></i> {{ material.upload_date.strftime('%d.%m.%Y') }}</span>
            </div>
        </div>
        <div>
            <a href="/download/material/{{ material.id }}" class="btn btn-sm btn-primary">
                <i class="bi bi-download"></i> Скачать
            </a>
            <form method="POST" action="/teacher/delete_material/{{ material.id }}" style="display: inline;" onsubmit="return confirm('Удалить этот материал?')">
                <button type="submit" class="btn btn-sm btn-delete">
                        <i class="bi bi-trash"></i> Удалить
                    </button>
            </form>
        </div>
    </div>
    {% endfor %} {% else %}
    <p class="text-muted text-center" style="padding: 40px 0;">
        <i class="bi bi-inbox" style="font-size: 48px; display: block; margin-bottom: 10px;"></i> Материалов пока нет. Загрузите первый!
    </p>
    {% endif %}
</div>

<script>
    function updateFileName(input) {
        const fileName = input.files[0] ? input.files[0].name : 'Файл не выбран';
        document.getElementById('fileName').textContent = fileName;
    }

    // Управление выбором групп
    let selectedGroups = [];
    const groupsSelector = document.getElementById('groupsSelector');
    const groupsDropdownList = document.getElementById('groupsDropdownList');
    const groupsPlaceholder = document.getElementById('groupsPlaceholder');
    const groupNamesInput = document.getElementById('groupNamesInput');

    // Открытие/закрытие списка при клике на селектор
    groupsSelector.addEventListener('click', function(e) {
        // Если клик не по крестику удаления
        if (!e.target.classList.contains('remove-badge')) {
            groupsDropdownList.classList.toggle('show');
        }
    });

    // Закрытие при клике вне элемента
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#groupsSelector') && !e.target.closest('.groups-dropdown-list')) {
            groupsDropdownList.classList.remove('show');
        }
    });

    // Обработка выбора/отмены групп
    document.querySelectorAll('.group-option-item input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const groupName = this.value;

            if (this.checked) {
                if (!selectedGroups.includes(groupName)) {
                    selectedGroups.push(groupName);
                }
            } else {
                selectedGroups = selectedGroups.filter(g => g !== groupName);
            }

            updateGroupsDisplay();
        });
    });

    // Обновление отображения выбранных групп
    function updateGroupsDisplay() {
        // Очищаем селектор
        groupsSelector.innerHTML = '';

        if (selectedGroups.length === 0) {
            groupsSelector.innerHTML = '<span id="groupsPlaceholder" style="color: #6c757d;">Выберите группы</span>';
            groupNamesInput.value = '';
        } else {
            selectedGroups.forEach(group => {
                const badge = document.createElement('span');
                badge.className = 'selected-group-badge';
                badge.innerHTML = `${group} <span class="remove-badge" data-group="${group}">×</span>`;
                groupsSelector.appendChild(badge);
            });

            // Обновляем скрытое поле
            groupNamesInput.value = selectedGroups.join(',');
        }
    }

    // Удаление группы по клику на крестик
    groupsSelector.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-badge')) {
            e.stopPropagation();
            const groupName = e.target.dataset.group;
            selectedGroups = selectedGroups.filter(g => g !== groupName);

            // Снимаем галочку с чекбокса
            document.querySelectorAll('.group-option-item input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.value === groupName) {
                    checkbox.checked = false;
                }
            });

            updateGroupsDisplay();
        }
    });

    // Валидация формы
    document.querySelector('form').addEventListener('submit', function(e) {
        if (selectedGroups.length === 0) {
            e.preventDefault();
            alert('Пожалуйста, выберите хотя бы одну группу');
            return false;
        }
    });

    function updateFileName(input) {
        const fileName = input.files[0] ? input.files[0].name : 'Файл не выбран';
        document.getElementById('fileName').textContent = fileName;
    }
</script>
{% endblock %}