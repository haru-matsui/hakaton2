{% extends "base.html" %} {% block title %}–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ{% endblock %} {% block extra_css %}
<style>
    .group-selector {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }
    
    .group-selector h5 {
        margin-bottom: 15px;
        color: var(--primary-color);
    }
    
    .group-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .group-btn {
        padding: 10px 20px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
    }
    
    .group-btn:hover {
        border-color: var(--primary-color);
        background: #f8f9fa;
    }
    
    .group-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .week-selector {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .week-selector button {
        background: white;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        border-radius: 10px;
        padding: 10px 20px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .week-selector button:hover {
        background: var(--primary-color);
        color: white;
    }
    
    .week-selector h4 {
        margin: 0;
        color: var(--primary-color);
        font-weight: 700;
    }
    
    .tabs-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        overflow-x: auto;
        padding-bottom: 10px;
    }
    
    .tab-btn {
        flex: 1;
        min-width: 120px;
        padding: 15px;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }
    
    .tab-btn:hover {
        border-color: var(--primary-color);
    }
    
    .tab-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .day-content {
        display: none;
    }
    
    .day-content.active {
        display: block;
    }
    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–Ω—è —Å –∑–∞–º–µ—Ç–∫–æ–π */
    
    .day-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .dayname {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin: 0;
    }
    /* –ó–∞–º–µ—Ç–∫–∞ - –ø—Ä–æ—Å—Ç—ã–µ —Å—Ç–∏–ª–∏ */
    
    .note-btn,
    .note-text {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        border: none;
        cursor: pointer;
    }
    
    .note-btn {
        background: var(--primary-color);
        color: white;
    }
    
    .note-btn:hover {
        background: var(--primary-hover);
        opacity: 0.9;
    }
    
    .note-text {
        background: #cbb8ff;
        border: 2px solid var(--warning-color);
        color: #2a1468;
        max-width: 300px;
        word-wrap: break-word;
    }
    
    .lesson {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        transition: all 0.3s;
    }
    
    .lesson:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    
    .lesson.type0 {
        border-left: 5px solid var(--primary-color);
    }
    
    .lesson.type1 {
        border-left: 5px solid var(--success-color);
    }
    
    .lesson.type15 {
        border-left: 5px solid var(--warning-color);
    }
    
    .lesson.nothing {
        border-left: 5px solid var(--secondary-color);
        background: #e8e8e8;
    }
    
    .lesson .time {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 10px;
    }
    
    .lesson h2 {
        font-size: 1rem;
        color: var(--primary-color);
        margin-bottom: 8px;
    }
    
    .lesson__name {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .bottom-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #e0e0e0;
    }
    
    .bottom-info p {
        margin: 0;
        font-size: 0.9rem;
        color: #666;
    }
    
    .loading {
        text-align: center;
        padding: 50px;
    }
    
    .no-schedule {
        text-align: center;
        padding: 50px;
        background: white;
        border-radius: 15px;
    }
</style>
{% endblock %} {% block content %}
<div class="page-header">
    <h1><i class="bi bi-calendar3"></i> –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π</h1>
</div>

<!-- –í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã -->
<div class="group-selector">
    <h5><i class="bi bi-people-fill"></i> –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É:</h5>
    <div class="group-buttons" id="groupButtons">
        {% for group in groups %}
        <button class="group-btn {% if group == current_group %}active{% endif %}" onclick="selectGroup('{{ group }}')">
            {{ group }}
        </button> {% endfor %}
    </div>
</div>

<!-- –í—ã–±–æ—Ä –Ω–µ–¥–µ–ª–∏ -->
<div class="week-selector">
    <button onclick="changeWeek(-1)">
        <i class="bi bi-chevron-double-left"></i> –ü—Ä–µ–¥—ã–¥—É—â–∞—è
    </button>
    <h4>–ù–µ–¥–µ–ª—è <span id="currentWeek">8</span></h4>
    <button onclick="changeWeek(1)">
        –°–ª–µ–¥—É—é—â–∞—è <i class="bi bi-chevron-double-right"></i>
    </button>
    <button onclick="goToCurrentWeek()">
        <i class="bi bi-calendar-check"></i> –¢–µ–∫—É—â–∞—è
    </button>
</div>

<!-- –¢–∞–±—ã –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ -->
<div class="tabs-bar" id="tabsBar">
    <button class="tab-btn active" onclick="switchDay(0)">
        –ü–ù<br><small id="date-0">-</small>
    </button>
    <button class="tab-btn" onclick="switchDay(1)">
        –í–¢<br><small id="date-1">-</small>
    </button>
    <button class="tab-btn" onclick="switchDay(2)">
        –°–†<br><small id="date-2">-</small>
    </button>
    <button class="tab-btn" onclick="switchDay(3)">
        –ß–¢<br><small id="date-3">-</small>
    </button>
    <button class="tab-btn" onclick="switchDay(4)">
        –ü–¢<br><small id="date-4">-</small>
    </button>
    <button class="tab-btn" onclick="switchDay(5)">
        –°–ë<br><small id="date-5">-</small>
    </button>
</div>

<!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–Ω–µ–π -->
<div id="scheduleContent">
    <div class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <p class="mt-3">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...</p>
    </div>
</div>

<script>
    let currentWeek = 8;
    let currentGroup = '{{ current_group }}';
    let scheduleData = {};
    let currentDayIndex = 0;
    let allNotes = {};

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–º–µ—Ç–æ–∫
    async function loadNotes() {
        try {
            const res = await fetch('/api/notes/all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    group_name: currentGroup
                })
            });
            const data = await res.json();
            if (data.success) allNotes = data.notes;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–º–µ—Ç–æ–∫:', error);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    async function loadSchedule(groupName) {
        try {
            const response = await fetch(`/api/schedule/${groupName}`);
            scheduleData = await response.json();
            console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ:', scheduleData);
            await loadNotes();
            loadWeekSchedule();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:', error);
            document.getElementById('scheduleContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> 
                    –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
                </div>
            `;
        }
    }

    function selectGroup(groupName) {
        currentGroup = groupName;
        document.querySelectorAll('.group-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent.trim() === groupName);
        });
        loadSchedule(groupName);
    }

    function switchDay(dayIndex) {
        currentDayIndex = dayIndex;
        document.querySelectorAll('.tab-btn').forEach((tab, idx) => {
            tab.classList.toggle('active', idx === dayIndex);
        });
        document.querySelectorAll('.day-content').forEach((day, idx) => {
            day.classList.toggle('active', idx === dayIndex);
        });
    }

    function changeWeek(delta) {
        currentWeek = Math.max(1, Math.min(18, currentWeek + delta));
        document.getElementById('currentWeek').textContent = currentWeek;
        loadWeekSchedule();
    }

    function goToCurrentWeek() {
        currentWeek = 8;
        document.getElementById('currentWeek').textContent = currentWeek;
        loadWeekSchedule();
    }

    function loadWeekSchedule() {
        const weekData = scheduleData['–Ω–µ–¥–µ–ª–∏'] && scheduleData['–Ω–µ–¥–µ–ª–∏'][currentWeek] ? scheduleData['–Ω–µ–¥–µ–ª–∏'][currentWeek] : null;

        if (!weekData) {
            document.getElementById('scheduleContent').innerHTML = `
                <div class="no-schedule">
                    <i class="bi bi-calendar-x display-1 text-muted"></i>
                    <h3 class="mt-3">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                    <p class="text-muted">–î–ª—è –Ω–µ–¥–µ–ª–∏ ${currentWeek} —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
                </div>
            `;
            return;
        }

        const daysOrder = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
        let html = '';

        daysOrder.forEach((dayName, index) => {
            const dayData = weekData[dayName];
            const isActive = index === 0 ? 'active' : '';
            const noteKey = `${currentWeek}_${dayName}`;
            const note = allNotes[noteKey] || '';

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—ã –≤ —Ç–∞–±–∞—Ö
            if (dayData && dayData['–¥–∞—Ç–∞']) {
                document.getElementById(`date-${index}`).textContent = dayData['–¥–∞—Ç–∞'];
            } else {
                document.getElementById(`date-${index}`).textContent = '-';
            }

            html += `<div class="day-content ${isActive}">`;
            html += `<div class="day-header">`;
            html += `<p class="dayname">${dayName} ${dayData ? '(' + dayData['–¥–∞—Ç–∞'] + ')' : ''}</p>`;

            // –ó–∞–º–µ—Ç–∫–∞
            html += `<div id="note-${currentWeek}-${dayName}">`;
            if (note) {
                html += `<span class="note-text" onclick="editNote(${currentWeek}, '${dayName}')">üìù ${note}</span>`;
            } else {
                html += `<button class="note-btn" onclick="editNote(${currentWeek}, '${dayName}')">+ –ó–∞–º–µ—Ç–∫–∞</button>`;
            }
            html += `</div>`;

            html += `</div>`;

            // –ü–∞—Ä—ã
            if (dayData && dayData['–ø–∞—Ä—ã'] && dayData['–ø–∞—Ä—ã'].length > 0) {
                dayData['–ø–∞—Ä—ã'].forEach(lesson => {
                    const type = lesson['—Ç–∏–ø'] === '–õ–µ–∫—Ü–∏—è' ? 'type0' :
                        lesson['—Ç–∏–ø'].includes('–ü—Ä–∞–∫—Ç–∏–∫–∞') ? 'type1' : 'type15';

                    html += `
                        <div class="lesson ${type}">
                            <p class="time"><b>${lesson['–≤—Ä–µ–º—è']}</b> (${lesson['–Ω–æ–º–µ—Ä_–ø–∞—Ä—ã']} –ø–∞—Ä–∞)</p>
                            <h2>${lesson['–Ω–æ–º–µ—Ä_–ø–∞—Ä—ã']}. ${lesson['—Ç–∏–ø']}</h2>
                            <p class="lesson__name">${lesson['–ø—Ä–µ–¥–º–µ—Ç']}</p>
                            <div class="bottom-info">
                                <p><i class="bi bi-geo-alt-fill"></i> ${lesson['–∞—É–¥–∏—Ç–æ—Ä–∏—è'] || '–ê—É–¥–∏—Ç–æ—Ä–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                                <p><i class="bi bi-person-fill"></i> ${lesson['–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å'] || ''}</p>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div class="lesson nothing">
                        <p class="time"><b>08:00-09:20</b> (1 –ø–∞—Ä–∞)</p>
                        <h2>–ó–∞–Ω—è—Ç–∏–π –Ω–µ—Ç</h2>
                    </div>
                `;
            }

            html += '</div>';
        });

        document.getElementById('scheduleContent').innerHTML = html;
        switchDay(0);
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏
    function editNote(week, day) {
        const container = document.getElementById(`note-${week}-${day}`);
        const noteKey = `${week}_${day}`;
        const currentNote = allNotes[noteKey] || '';

        const input = prompt('–í–≤–µ–¥–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É (–º–∞–∫—Å. 64 —Å–∏–º–≤–æ–ª–∞):', currentNote);

        if (input === null) return;

        if (input.trim() === '') {
            if (currentNote && confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É?')) {
                deleteNote(week, day);
            }
        } else {
            saveNote(week, day, input.trim().substring(0, 64));
        }
    }

    async function saveNote(week, day, text) {
        try {
            const res = await fetch('/api/notes/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    group_name: currentGroup,
                    week_number: week,
                    day_name: day,
                    note_text: text
                })
            });
            const data = await res.json();
            if (data.success) {
                allNotes[`${week}_${day}`] = text;
                loadWeekSchedule();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏:', error);
        }
    }

    async function deleteNote(week, day) {
        try {
            const res = await fetch('/api/notes/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    group_name: currentGroup,
                    week_number: week,
                    day_name: day
                })
            });
            const data = await res.json();
            if (data.success) {
                delete allNotes[`${week}_${day}`];
                loadWeekSchedule();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏:', error);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    document.addEventListener('DOMContentLoaded', () => loadSchedule(currentGroup));
</script>
{% endblock %}