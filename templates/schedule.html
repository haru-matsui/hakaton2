{% extends "base.html" %} {% block title %}Расписание{% endblock %} {% block extra_css %}
<style>
    .group-selector {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }
    
    .group-selector h5 {
        margin-bottom: 15px;
        color: var(--primary-color);
    }
    
    .group-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .group-btn {
        padding: 10px 20px;
        border: 2px solid #e8e8e8;
        background: white;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 500;
    }
    
    .group-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .week-selector {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .week-selector button {
        background: white;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        border-radius: 10px;
        padding: 10px 20px;
        cursor: pointer;
    }
    
    .week-selector h4 {
        margin: 0;
        color: var(--primary-color);
        font-weight: 700;
    }
    
    .tabs-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        overflow-x: auto;
        padding-bottom: 10px;
    }
    
    .tab-btn {
        flex: 1;
        min-width: 120px;
        padding: 15px;
        background: white;
        border: 2px solid #e8e8e8;
        border-radius: 10px;
        cursor: pointer;
        text-align: center;
    }
    
    .tab-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .day-content {
        display: none;
    }
    
    .day-content.active {
        display: block;
    }
    /* Заголовок дня с заметкой */
    
    .day-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .dayname {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin: 0;
    }
    /* Заметка - простые стили */
    
    .note-btn,
    .note-text {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        border: none;
        cursor: pointer;
    }
    
    .note-btn {
        background: var(--primary-color);
        color: white;
    }
    
    .note-text {
        background: #cbb8ff;
        border: none;
        color: white;
        max-width: 300px;
        word-wrap: break-word;
    }
    
    .lesson {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }
    
    .lesson.type0 {
        border-left: 5px solid var(--primary-color);
    }
    
    .lesson.type1 {
        border-left: 5px solid var(--success-color);
    }
    
    .lesson.type15 {
        border-left: 5px solid var(--warning-color);
    }
    
    .lesson.nothing {
        border-left: 5px solid var(--secondary-color);
        background: #e8e8e8;
    }
    
    .lesson .time {
        color: #2a1468;
        font-size: 0.9rem;
        margin-bottom: 10px;
    }
    
    .lesson h2 {
        font-size: 1rem;
        color: var(--primary-color);
        margin-bottom: 8px;
    }
    
    .lesson__name {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .bottom-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #e8e8e8;
    }
    
    .bottom-info p {
        margin: 0;
        font-size: 0.9rem;
        color: #2a1468;
    }
    
    .loading {
        text-align: center;
        padding: 50px;
    }
    
    .no-schedule {
        text-align: center;
        padding: 50px;
        background: white;
        border-radius: 15px;
    }
</style>
{% endblock %} {% block content %}
<div class="page-header">
    <h1><i class="bi bi-calendar3"></i> Расписание занятий</h1>
</div>

<!-- Выбор группы -->
<div class="group-selector">
    <h5><i class="bi bi-people-fill"></i> Выберите группу:</h5>
    <div class="group-buttons" id="groupButtons">
        {% for group in groups %}
        <button class="group-btn {% if group == current_group %}active{% endif %}" onclick="selectGroup('{{ group }}')">
            {{ group }}
        </button> {% endfor %}
    </div>
</div>

<!-- Выбор недели -->
<div class="week-selector">
    <button onclick="changeWeek(-1)">
        <i class="bi bi-chevron-double-left"></i> Предыдущая
    </button>
    <h4>Неделя <span id="currentWeek">8</span></h4>
    <button onclick="changeWeek(1)">
        Следующая <i class="bi bi-chevron-double-right"></i>
    </button>
    <button onclick="goToCurrentWeek()">
        <i class="bi bi-calendar-check"></i> Текущая
    </button>
</div>

<!-- Табы дней недели -->
<div class="tabs-bar" id="tabsBar">
    <button class="tab-btn active" onclick="switchDay(0)">
        ПН<br><small id="date-0">-</small>
    </button>
    <button class="tab-btn" onclick="switchDay(1)">
        ВТ<br><small id="date-1">-</small>
    </button>
    <button class="tab-btn" onclick="switchDay(2)">
        СР<br><small id="date-2">-</small>
    </button>
    <button class="tab-btn" onclick="switchDay(3)">
        ЧТ<br><small id="date-3">-</small>
    </button>
    <button class="tab-btn" onclick="switchDay(4)">
        ПТ<br><small id="date-4">-</small>
    </button>
    <button class="tab-btn" onclick="switchDay(5)">
        СБ<br><small id="date-5">-</small>
    </button>
</div>

<!-- Содержимое дней -->
<div id="scheduleContent">
    <div class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
        <p class="mt-3">Загрузка расписания...</p>
    </div>
</div>

<script>
    let currentWeek = 8;
    let currentGroup = '{{ current_group }}';
    let scheduleData = {};
    let currentDayIndex = 0;
    let allNotes = {};

    // Загрузка заметок
    async function loadNotes() {
        try {
            const res = await fetch('/api/notes/all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    group_name: currentGroup
                })
            });
            const data = await res.json();
            if (data.success) allNotes = data.notes;
        } catch (error) {
            console.error('Ошибка загрузки заметок:', error);
        }
    }

    // Загрузка расписания
    async function loadSchedule(groupName) {
        try {
            const response = await fetch(`/api/schedule/${groupName}`);
            scheduleData = await response.json();
            console.log('Загружено расписание:', scheduleData);
            await loadNotes();
            loadWeekSchedule();
        } catch (error) {
            console.error('Ошибка загрузки расписания:', error);
            document.getElementById('scheduleContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> 
                    Ошибка загрузки расписания
                </div>
            `;
        }
    }

    function selectGroup(groupName) {
        currentGroup = groupName;
        document.querySelectorAll('.group-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent.trim() === groupName);
        });
        loadSchedule(groupName);
    }

    function switchDay(dayIndex) {
        currentDayIndex = dayIndex;
        document.querySelectorAll('.tab-btn').forEach((tab, idx) => {
            tab.classList.toggle('active', idx === dayIndex);
        });
        document.querySelectorAll('.day-content').forEach((day, idx) => {
            day.classList.toggle('active', idx === dayIndex);
        });
    }

    function changeWeek(delta) {
        currentWeek = Math.max(1, Math.min(18, currentWeek + delta));
        document.getElementById('currentWeek').textContent = currentWeek;
        loadWeekSchedule();
    }

    function goToCurrentWeek() {
        currentWeek = 8;
        document.getElementById('currentWeek').textContent = currentWeek;
        loadWeekSchedule();
    }

    function loadWeekSchedule() {
        const weekData = scheduleData['недели'] && scheduleData['недели'][currentWeek] ? scheduleData['недели'][currentWeek] : null;

        if (!weekData) {
            document.getElementById('scheduleContent').innerHTML = `
                <div class="no-schedule">
                    <i class="bi bi-calendar-x display-1 text-muted"></i>
                    <h3 class="mt-3">Расписание не найдено</h3>
                    <p class="text-muted">Для недели ${currentWeek} расписание отсутствует</p>
                </div>
            `;
            return;
        }

        const daysOrder = ['Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
        let html = '';

        daysOrder.forEach((dayName, index) => {
            const dayData = weekData[dayName];
            const isActive = index === 0 ? 'active' : '';
            const noteKey = `${currentWeek}_${dayName}`;
            const note = allNotes[noteKey] || '';

            // Обновляем даты в табах
            if (dayData && dayData['дата']) {
                document.getElementById(`date-${index}`).textContent = dayData['дата'];
            } else {
                document.getElementById(`date-${index}`).textContent = '-';
            }

            html += `<div class="day-content ${isActive}">`;
            html += `<div class="day-header">`;
            html += `<p class="dayname">${dayName} ${dayData ? '(' + dayData['дата'] + ')' : ''}</p>`;

            // Заметка
            html += `<div id="note-${currentWeek}-${dayName}">`;
            if (note) {
                html += `<span class="note-text" onclick="editNote(${currentWeek}, '${dayName}')">${note}</span>`;
            } else {
                html += `<button class="note-btn" onclick="editNote(${currentWeek}, '${dayName}')">+ Заметка</button>`;
            }
            html += `</div>`;

            html += `</div>`;

            // Пары
            if (dayData && dayData['пары'] && dayData['пары'].length > 0) {
                dayData['пары'].forEach(lesson => {
                    const type = lesson['тип'] === 'Лекция' ? 'type0' :
                        lesson['тип'].includes('Практика') ? 'type1' : 'type15';

                    html += `
                        <div class="lesson ${type}">
                            <p class="time"><b>${lesson['время']}</b> (${lesson['номер_пары']} пара)</p>
                            <h2>${lesson['номер_пары']}. ${lesson['тип']}</h2>
                            <p class="lesson__name">${lesson['предмет']}</p>
                            <div class="bottom-info">
                                <p><i class="bi bi-geo-alt-fill"></i> ${lesson['аудитория'] || 'Аудитория не указана'}</p>
                                <p><i class="bi bi-person-fill"></i> ${lesson['преподаватель'] || ''}</p>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div class="lesson nothing">
                        <p class="time"><b>08:00-09:20</b> (1 пара)</p>
                        <h2>Занятий нет</h2>
                    </div>
                `;
            }

            html += '</div>';
        });

        document.getElementById('scheduleContent').innerHTML = html;
        switchDay(0);
    }

    // Редактирование заметки
    function editNote(week, day) {
        const container = document.getElementById(`note-${week}-${day}`);
        const noteKey = `${week}_${day}`;
        const currentNote = allNotes[noteKey] || '';

        const input = prompt('Введите заметку (макс. 64 символа):', currentNote);

        if (input === null) return;

        if (input.trim() === '') {
            if (currentNote && confirm('Удалить заметку?')) {
                deleteNote(week, day);
            }
        } else {
            saveNote(week, day, input.trim().substring(0, 64));
        }
    }

    async function saveNote(week, day, text) {
        try {
            const res = await fetch('/api/notes/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    group_name: currentGroup,
                    week_number: week,
                    day_name: day,
                    note_text: text
                })
            });
            const data = await res.json();
            if (data.success) {
                allNotes[`${week}_${day}`] = text;
                loadWeekSchedule();
            }
        } catch (error) {
            console.error('Ошибка сохранения заметки:', error);
        }
    }

    async function deleteNote(week, day) {
        try {
            const res = await fetch('/api/notes/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    group_name: currentGroup,
                    week_number: week,
                    day_name: day
                })
            });
            const data = await res.json();
            if (data.success) {
                delete allNotes[`${week}_${day}`];
                loadWeekSchedule();
            }
        } catch (error) {
            console.error('Ошибка удаления заметки:', error);
        }
    }

    // Загрузка при старте
    document.addEventListener('DOMContentLoaded', () => loadSchedule(currentGroup));
</script>
{% endblock %}